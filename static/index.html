<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgentForge ‚Äî Healthcare AI</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f4f8;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: #1a202c;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: #1a56db;
      color: #fff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    header .icon { font-size: 28px; }
    header h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
    header p  { font-size: 12px; opacity: 0.85; margin-top: 2px; }

    /* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ */
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ‚îÄ‚îÄ Welcome card ‚îÄ‚îÄ */
    .welcome {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      max-width: 680px;
      width: 100%;
      align-self: center;
    }
    .welcome h2 { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: #1a56db; }
    .welcome p  { font-size: 13px; color: #4a5568; margin-bottom: 14px; line-height: 1.5; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      background: #ebf4ff;
      border: 1px solid #bee3f8;
      color: #1a56db;
      border-radius: 20px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .chip:hover { background: #bee3f8; }

    /* ‚îÄ‚îÄ Message bubbles ‚îÄ‚îÄ */
    .msg { display: flex; flex-direction: column; max-width: 680px; width: 100%; }
    .msg.user { align-self: flex-end; align-items: flex-end; }
    .msg.agent { align-self: center; align-items: flex-start; }

    .bubble {
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user  .bubble { background: #1a56db; color: #fff; border-bottom-right-radius: 4px; }
    .msg.agent .bubble { background: #fff; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; color: #1a202c; }

    /* ‚îÄ‚îÄ Escalation banner ‚îÄ‚îÄ */
    .escalation-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff5f5;
      border: 1px solid #fc8181;
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 13px;
      color: #c53030;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Disclaimer ‚îÄ‚îÄ */
    .disclaimer {
      font-size: 11px;
      color: #a0aec0;
      margin-top: 6px;
      padding: 0 4px;
      line-height: 1.4;
    }

    /* ‚îÄ‚îÄ Confidence badge ‚îÄ‚îÄ */
    .confidence {
      font-size: 11px;
      color: #718096;
      margin-top: 4px;
      padding: 0 4px;
    }

    /* ‚îÄ‚îÄ Tool Trace ‚îÄ‚îÄ */
    .trace-container {
      margin-top: 8px;
    }
    .trace-container details {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
    }
    .trace-container summary {
      background: #f7fafc;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      user-select: none;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .trace-container summary::-webkit-details-marker { display: none; }
    .trace-container summary::before {
      content: '‚ñ∂';
      font-size: 9px;
      transition: transform 0.15s;
    }
    .trace-container details[open] summary::before { transform: rotate(90deg); }
    .trace-steps { padding: 10px 12px; display: flex; flex-direction: column; gap: 10px; }
    .trace-step {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      overflow: hidden;
    }
    .trace-step-header {
      background: #ebf4ff;
      padding: 5px 10px;
      font-size: 11px;
      font-weight: 700;
      color: #1a56db;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .trace-step-body { padding: 8px 10px; display: flex; flex-direction: column; gap: 6px; }
    .trace-label {
      font-size: 10px;
      font-weight: 700;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .trace-json {
      background: #1a202c;
      color: #68d391;
      border-radius: 4px;
      padding: 7px 10px;
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 160px;
      overflow-y: auto;
    }

    /* ‚îÄ‚îÄ Typing indicator ‚îÄ‚îÄ */
    .typing .bubble {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 14px 18px;
    }
    .dot {
      width: 7px; height: 7px;
      background: #a0aec0;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%           { transform: translateY(-6px); }
    }

    /* ‚îÄ‚îÄ Input bar ‚îÄ‚îÄ */
    #input-bar {
      background: #fff;
      border-top: 1px solid #e2e8f0;
      padding: 14px 16px;
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    #input {
      flex: 1;
      border: 1px solid #cbd5e0;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
      resize: none;
      height: 44px;
      font-family: inherit;
    }
    #input:focus { border-color: #1a56db; }
    #send-btn {
      background: #1a56db;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      height: 44px;
      white-space: nowrap;
    }
    #send-btn:hover   { background: #1e429f; }
    #send-btn:disabled { background: #a0aec0; cursor: not-allowed; }
  </style>
</head>
<body>

<header>
  <div class="icon">üè•</div>
  <div>
    <h1>AgentForge ‚Äî Healthcare AI</h1>
    <p>Medication safety review powered by AI ¬∑ Built on OpenEMR</p>
  </div>
</header>

<div id="chat">
  <div class="welcome">
    <h2>What can I help you with?</h2>
    <p>Ask me about patient medications, drug interactions, or allergy conflicts. Try one of the examples below or type your own question.</p>
    <div class="chips">
      <button class="chip" onclick="sendChip(this)">üíä What medications is John Smith on?</button>
      <button class="chip" onclick="sendChip(this)">‚ö†Ô∏è Check drug interactions for Mary Johnson</button>
      <button class="chip" onclick="sendChip(this)">üö® Is it safe to give Robert Davis Aspirin?</button>
      <button class="chip" onclick="sendChip(this)">ü©∫ Does John Smith have any known allergies?</button>
    </div>
  </div>
</div>

<div id="input-bar">
  <textarea id="input" placeholder="Ask about a patient's medications, interactions, or allergies‚Ä¶" rows="1"></textarea>
  <button id="send-btn" onclick="sendMessage()">Send</button>
</div>

<script>
  let sessionId = null;

  const chat     = document.getElementById('chat');
  const input    = document.getElementById('input');
  const sendBtn  = document.getElementById('send-btn');

  // Send on Enter (Shift+Enter for newline)
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  function sendChip(btn) {
    // Strip emoji prefix for the actual query text
    const text = btn.textContent.replace(/^[\u{1F300}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}‚ö†üö®üíäü©∫üè•]\s*/u, '').trim();
    input.value = text;
    sendMessage();
  }

  function appendUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'msg user';
    div.innerHTML = `<div class="bubble">${escHtml(text)}</div>`;
    chat.appendChild(div);
    scrollBottom();
  }

  function appendTyping() {
    const div = document.createElement('div');
    div.className = 'msg agent typing';
    div.id = 'typing-indicator';
    div.innerHTML = `<div class="bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
    chat.appendChild(div);
    scrollBottom();
    return div;
  }

  function removeTyping() {
    const el = document.getElementById('typing-indicator');
    if (el) el.remove();
  }

  function buildTraceHtml(toolTrace) {
    if (!toolTrace || toolTrace.length === 0) return '';
    const steps = toolTrace.map((step, i) => `
      <div class="trace-step">
        <div class="trace-step-header">üîß Step ${i + 1} ‚Äî ${escHtml(step.tool)}</div>
        <div class="trace-step-body">
          <div class="trace-label">Input</div>
          <div class="trace-json">${escHtml(JSON.stringify(step.input, null, 2))}</div>
          <div class="trace-label">Output</div>
          <div class="trace-json">${escHtml(JSON.stringify(step.output, null, 2))}</div>
        </div>
      </div>`).join('');
    return `
      <div class="trace-container">
        <details>
          <summary>üõ†Ô∏è Tool Trace (${toolTrace.length} call${toolTrace.length > 1 ? 's' : ''})</summary>
          <div class="trace-steps">${steps}</div>
        </details>
      </div>`;
  }

  function appendAgentMessage(data) {
    const div = document.createElement('div');
    div.className = 'msg agent';

    const escalationHtml = data.escalate
      ? `<div class="escalation-banner">üî¥ Physician Review Recommended ‚Äî Confidence below threshold. Do not proceed without clinical oversight.</div>`
      : '';

    const confidencePct = Math.round((data.confidence || 0) * 100);
    const traceHtml = buildTraceHtml(data.tool_trace);

    div.innerHTML = `
      <div class="bubble">${escHtml(data.answer)}</div>
      ${escalationHtml}
      <div class="confidence">Confidence: ${confidencePct}%</div>
      <div class="disclaimer">${escHtml(data.disclaimer || '')}</div>
      ${traceHtml}
    `;
    chat.appendChild(div);
    scrollBottom();
  }

  function appendErrorMessage(text) {
    const div = document.createElement('div');
    div.className = 'msg agent';
    div.innerHTML = `<div class="bubble" style="border-color:#fc8181;color:#c53030;">${escHtml(text)}</div>`;
    chat.appendChild(div);
    scrollBottom();
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    sendBtn.disabled = true;

    appendUserMessage(text);
    const typing = appendTyping();

    try {
      const body = { question: text };
      if (sessionId) body.session_id = sessionId;

      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      removeTyping();

      if (!res.ok) {
        appendErrorMessage('The server returned an error. Please try again.');
      } else {
        const data = await res.json();
        sessionId = data.session_id;
        appendAgentMessage(data);
      }
    } catch (err) {
      removeTyping();
      appendErrorMessage('Could not reach the server. Please check your connection and try again.');
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }

  function scrollBottom() {
    chat.scrollTop = chat.scrollHeight;
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/\n/g, '<br>');
  }
</script>
</body>
</html>
